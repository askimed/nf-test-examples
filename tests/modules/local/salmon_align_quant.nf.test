@Grab('org.codehaus.groovy:groovy-json:3.0.9')
import groovy.json.JsonSlurper

nextflow_process {

    name "Test Process SALMON_ALIGN_QUANT"
    script "modules/local/salmon_align_quant.nf"
    process "SALMON_ALIGN_QUANT"

    test("Should run without failures") {

        when {
            params {
                outdir = "tests/results"
            }
            process {
                """
                input[0] = file("test_data/step1_out")
                input[1] = file("test_data/reads_1.fq.gz")
                input[2] = file("test_data/reads_2.fq.gz")
                """
            }
        }

        then {
            assert process.success
            with(process.out) {
            // check if output directory has been created
            assert quant.size() == 1
            def jsonSlurper = new JsonSlurper()
            //parse cmd_info file
            def info = jsonSlurper.parseText(new File(quant.get(0)+'/cmd_info.json').text)
            assert info.mates1 == 'reads_1.fq.gz'
            assert info.mates2 == 'reads_2.fq.gz'
            //parse lib_format_counts file
            def counts = jsonSlurper.parseText(new File(quant.get(0)+'/lib_format_counts.json').text)
            assert counts.num_compatible_fragments == 100171
            }
        }

    }

}
